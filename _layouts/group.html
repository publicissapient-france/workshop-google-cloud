---
layout: main
cssDir: ../stylesheets
javascriptsDir: ../javascripts
---
<html><head><title>Atelier Google Cloud - 28 Novembre</title><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_y60use42zoqv-2>li:before{content:"\0025a0  "}ul.lst-kix_y60use42zoqv-3{list-style-type:none}ul.lst-kix_y60use42zoqv-4{list-style-type:none}ul.lst-kix_y60use42zoqv-1{list-style-type:none}ul.lst-kix_y60use42zoqv-2{list-style-type:none}ul.lst-kix_y60use42zoqv-0{list-style-type:none}.lst-kix_y60use42zoqv-5>li:before{content:"\0025a0  "}.lst-kix_y60use42zoqv-4>li:before{content:"\0025cb  "}.lst-kix_y60use42zoqv-1>li:before{content:"\0025cb  "}.lst-kix_y60use42zoqv-8>li:before{content:"\0025a0  "}.lst-kix_y60use42zoqv-0>li:before{content:"\0025cf  "}ul.lst-kix_y60use42zoqv-8{list-style-type:none}ul.lst-kix_y60use42zoqv-7{list-style-type:none}.lst-kix_y60use42zoqv-3>li:before{content:"\0025cf  "}ul.lst-kix_y60use42zoqv-6{list-style-type:none}.lst-kix_y60use42zoqv-7>li:before{content:"\0025cb  "}ul.lst-kix_y60use42zoqv-5{list-style-type:none}.lst-kix_y60use42zoqv-6>li:before{content:"\0025cf  "}ol{margin:0;padding:0}.c12{vertical-align:top;width:468pt;border-style:solid;background-color:#434343;border-color:#000000;border-width:1pt;padding:5pt 5pt 5pt 5pt}.c19{line-height:1.15;padding-top:0pt;text-align:left;padding-bottom:0pt}.c18{max-width:468pt;background-color:#ffffff;padding:72pt 72pt 72pt 72pt}.c16{margin-right:auto;border-collapse:collapse}.c22{line-height:1.0;padding-top:0pt;padding-bottom:0pt}.c6{color:#1155cc;text-decoration:underline}.c4{font-family:"Courier New";font-weight:bold}.c1{color:inherit;text-decoration:inherit}.c0{height:11pt;direction:ltr}.c8{font-size:11pt;font-family:"Arial"}.c2{direction:ltr;margin-left:36pt}.c3{margin:0;padding:0}.c5{direction:ltr}.c17{font-size:8pt}.c21{font-size:10pt}.c11{height:0pt}.c20{padding-left:0pt}.c14{font-style:italic}.c10{margin-left:18pt}.c7{font-family:"Courier New"}.c13{padding-top:10pt}.c23{font-weight:bold}.c15{text-align:right}.c9{color:#00ff00}.title{padding-top:0pt;line-height:1.15;text-align:left;color:#000000;font-size:21pt;font-family:"Trebuchet MS";padding-bottom:0pt}.subtitle{padding-top:0pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:13pt;font-family:"Trebuchet MS";padding-bottom:10pt}li{color:#000000;font-size:11pt;font-family:"Arial"}p{color:#000000;font-size:11pt;margin:0;font-family:"Arial"}h1{padding-top:10pt;line-height:1.15;text-align:left;color:#000000;font-size:16pt;font-family:"Trebuchet MS";padding-bottom:0pt}h2{padding-top:10pt;line-height:1.15;text-align:left;color:#000000;font-size:13pt;font-family:"Trebuchet MS";font-weight:bold;padding-bottom:0pt}h3{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-size:12pt;font-family:"Trebuchet MS";font-weight:bold;padding-bottom:0pt}h4{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-size:11pt;text-decoration:underline;font-family:"Trebuchet MS";padding-bottom:0pt}h5{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-size:11pt;font-family:"Trebuchet MS";padding-bottom:0pt}h6{padding-top:8pt;line-height:1.15;text-align:left;color:#666666;font-style:italic;font-size:11pt;font-family:"Trebuchet MS";padding-bottom:0pt}</style></head><body class="c18"><p class="c5"><span class="c23">Votre projet Compute Engine a pour project ID {{page.projectId}}</span></p><p class="c0"><span></span></p><p class="c5 c10"><span class="c6"><a class="c1" href="#h.rhj5fkexxyn6">1 - Cr&eacute;er une instance compute engine via la console web</a></span></p><p class="c5 c10"><span class="c6"><a class="c1" href="#h.1j10rvh061q0">2 - Connexion en ssh &agrave; l&rsquo;instance</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.stcm0kfqk1y7">2.1 - Installer le cloud sdk</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.5q3dg5lj6u94">2.2 - S&rsquo;authentifier avec votre projet {{page.projectId}}</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.s39hhemk030t">2.3 - Mettre en cache le nom du projet</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.xdho0ie3ugwc">2.4 - Connexion en ssh &agrave; l&rsquo;instance</a></span></p><p class="c5 c10"><span class="c6"><a class="c1" href="#h.h2c2qp88j5e7">3 - Installation de petclinic</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.brcr4cc2d4y6">3.1 - Installation de tomcat 7</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.af8fc3ctmpg5">3.2 - Acc&eacute;der &agrave; la page de test de tomcat 7</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.6mf3gmo84piw">3.3 - D&eacute;ploiement de petclinic</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.e1j3jx4fffh1">3.4 - Cr&eacute;ation d&rsquo;une base de donn&eacute;es Google Cloud SQL</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.i13fkd1hyfvb">3.5 - Autoriser Tomcat &agrave; acc&eacute;der &agrave; l&rsquo;instance Cloud SQL</a></span></p><p class="c5 c10"><span class="c6"><a class="c1" href="#h.zey36j5g0ghl">4 - Cr&eacute;ation d&rsquo;une seconde instance &agrave; partir de la premi&egrave;re</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.slmc1aqbm210">4.1 - Cr&eacute;ation d&rsquo;un snapshot</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.htvcqsgil4pb">4.2 - Cr&eacute;ation de la seconde instance en ligne de commande</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.a6dlfclqm65p">4.3 V&eacute;rifier que l&rsquo;on acc&egrave;de bien au petclinic sur la seconde instance</a></span></p><p class="c5 c10"><span class="c6"><a class="c1" href="#h.eslvtsrragcc">5 - Cr&eacute;ation d&rsquo;un load balancing</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.ldtzssrw2oxl">5.1 Cr&eacute;ation d&rsquo;une target pool</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.deb1y6eksnuv">5.2 - Cr&eacute;ation d&rsquo;un Forwarding Rule</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.7903yvvqrmvw">5.3 - Cr&eacute;ation d&rsquo;un Health Check</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.2s9zpc9t683x">5.4 - Se connecter &agrave; l&rsquo;ip du load balancer</a></span></p><p class="c2"><span class="c6"><a class="c1" href="#h.8320u58bvy5j">5.5 - Couper une VM</a></span></p><h1 class="c5"><a name="h.3jzvxtxx8fhl"></a><span>1 - Cr&eacute;er une instance compute engine via la console web</span></h1><p class="c0"><span></span></p><p class="c5"><span>&nbsp;- Ouvrez une fen&ecirc;tre en navigation priv&eacute;e pour ne pas utiliser votre compte google</span></p><p class="c5"><span>&nbsp;- Allez sur la console web de votre projet : </span><span class="c6"><a class="c1" href="https://cloud.google.com/console#/project/apps~{{page.projectId}}">https://cloud.google.com/console#/project/apps~{{page.projectId}}</a></span></p><p class="c5"><span>&nbsp;- Le login et mot de passe du compte a utiliser est pr&eacute;sent sur la fiche que vous nous avons donn&eacute;</span></p><p class="c0"><span></span></p><p class="c5"><img height="358" src="images/image18.png" width="628"></p><p class="c5"><span>&nbsp;- Cliquez sur VM Instances et cliquez sur le bouton New Instance</span></p><p class="c5"><span>-</span></p><p class="c5"><img height="370" src="images/image22.png" width="705"></p><p class="c5"><span>&nbsp;- Sur l&rsquo;&eacute;cran de cr&eacute;ation de la nouvelle instance : </span></p><ul class="c3 lst-kix_y60use42zoqv-0 start"><li class="c2 c20"><span>Name : {{page.projectName}}-tomcat-1</span></li><li class="c2 c20"><span>Zone : europe-west1-a</span></li><li class="c2 c20"><span>Machine Type : f1-micro</span></li></ul><p class="c0"><span></span></p><p class="c5"><img height="400" src="images/image01.png" width="705"></p><p class="c5"><span>&nbsp;- Une fois cr&eacute;&eacute;e, l&rsquo;instance d&eacute;marre en quelques secondes</span></p><p class="c0"><span></span></p><p class="c5"><img height="383" src="images/image20.png" width="705"></p><p class="c0"><span></span></p><h1 class="c5 c13"><a name="h.1j10rvh061q0"></a><span>2 - Connexion en ssh &agrave; l&rsquo;instance</span></h1><h2 class="c5 c13"><a name="h.stcm0kfqk1y7"></a><span>2.1 - Installer le cloud sdk</span></h2><p class="c0"><span></span></p><p class="c5"><span>&nbsp;- Pour le t&eacute;l&eacute;charger : </span><span class="c6"><a class="c1" href="https://developers.google.com/cloud/sdk/">https://developers.google.com/cloud/sdk/</a></span></p><p class="c5"><span>&nbsp;- D&eacute;zipper l&rsquo;install dans le r&eacute;pertoire de votre choix.</span></p><p class="c5"><span>&nbsp;- Executer le fichier install.sh (install.bat sous windows)</span></p><p class="c5"><span>&nbsp;- Suivre les instructions, pour l&rsquo;atelier nous n&rsquo;avons pas besoin d&rsquo;appengine.</span></p><h2 class="c5 c13"><a name="h.5q3dg5lj6u94"></a><span>2.2 - S&rsquo;authentifier avec votre projet </span><span class="c8">{{page.projectId}}</span></h2><p class="c0"><span></span></p><p class="c5"><span>&nbsp;- La premi&egrave;re chose avant de commencer est de vous authentifier (Attention ! Utilisez bien le compte google pr&eacute;sent sur la fiche que l&rsquo;on vous a donn&eacute; !) &nbsp;:</span></p><p class="c5"><span class="c4">Local</span></p><a href="#" name="e27077f5c45b45b094bad8492a67baf47015980b"></a><a href="#" name="0"></a><table cellpadding="0" cellspacing="0" class="c16"><tbody><tr><td class="c12"><p class="c5 c22"><span class="c7 c9">gcloud auth login</span></p></td></tr></tbody></table><p class="c0"><span class="c7"></span></p><p class="c5"><span>- Copier dans votre navigateur l&rsquo;URL apparu sur la ligne de commande. </span></p><p class="c5"><span>- Recopier ensuite le code dans votre invit&eacute; de commande.</span></p><h2 class="c5"><a name="h.s39hhemk030t"></a><span>2.3 - Mettre en cache le nom du projet</span></h2><p class="c0"><span></span></p><p class="c5"><span>&nbsp;- Pour &eacute;viter d&rsquo;avoir &agrave; retaper le nom du projet &agrave; chaque commande, vous pouvez mettre en cache le flag du nom du projet : </span></p><p class="c0"><span></span></p><p class="c5"><span class="c4">Local</span></p><a href="#" name="4f51b5cbbfc649926c9ddacc2aadf7321db64410"></a><a href="#" name="1"></a><table cellpadding="0" cellspacing="0" class="c16"><tbody><tr><td class="c12"><p class="c22 c5"><span class="c7 c9">gcutil --project={{page.projectId}} getproject --cache_flag_values</span></p></td></tr></tbody></table><p class="c0"><span class="c7"></span></p><h2 class="c5"><a name="h.xdho0ie3ugwc"></a><span>2.4 - Connexion en ssh &agrave; l&rsquo;instance </span></h2><p class="c0"><span></span></p><p class="c5"><span class="c4">Local</span></p><a href="#" name="661ee566c8ba4fca24098389a53627b8a20665e6"></a><a href="#" name="2"></a><table cellpadding="0" cellspacing="0" class="c16"><tbody><tr><td class="c12"><p class="c5"><span class="c7 c9">gcutil ssh {{page.projectName}}-tomcat-1</span></p></td></tr></tbody></table><p class="c0"><span></span></p><p class="c5"><span>Notez au passage que lors de l&rsquo;ex&eacute;cution de la commande, gcutil vous donne la commande ssh utilis&eacute;e t se connecter &agrave; votre instance. Par exemple:</span></p><p class="c5"><span class="c17 c14 c7">INFO: Running command line: ssh -o UserKnownHostsFile=/dev/null -o CheckHostIP=no -o StrictHostKeyChecking=no -i /Users/jbclaramonte/.ssh/google_compute_engine -A -p 22 jbclaramonte@192.157.29.85 --</span></p><h1 class="c5"><a name="h.h2c2qp88j5e7"></a><span>3 - Installation de petclinic</span></h1><h2 class="c5"><a name="h.brcr4cc2d4y6"></a><span>3.1 - Installation de tomcat 7</span></h2><p class="c0"><span></span></p><p class="c5"><span class="c4">{{page.projectName}}-tomcat-1</span></p><a href="#" name="ab6d56546392cafcb8f8f5072158cb5290eae543"></a><a href="#" name="3"></a><table cellpadding="0" cellspacing="0" class="c16"><tbody><tr><td class="c12"><p class="c5"><span class="c7 c9">sudo apt-get install tomcat7</span></p></td></tr></tbody></table><p class="c0"><span></span></p><h2 class="c5"><a name="h.af8fc3ctmpg5"></a><span>3.2 - Acc&eacute;der &agrave; la page de test de tomcat 7</span></h2><p class="c0"><span></span></p><p class="c5"><span>Pour acc&eacute;der &agrave; votre instance en http, utiliser l&rsquo;ip qui est affich&eacute;e sur la page listant les instances de votre projet : </span></p><p class="c0"><span></span></p><p class="c5"><img height="383" src="images/image14.png" width="705"></p><p class="c0"><span></span></p><p class="c5"><span>Et par d&eacute;faut, tomcat expose sur le port 8080. </span></p><p class="c0"><span></span></p><p class="c5"><span>On s&rsquo;aper&ccedil;oit que l&rsquo;on ne peut pas acc&eacute;der au port 8080 par d&eacute;faut. Il faut configurer les r&egrave;gles firewall.</span></p><p class="c0"><span></span></p><p class="c5"><span>Pour se faire : </span></p><p class="c0"><span></span></p><p class="c5"><span>- Allez dans la section Network de Compute Engine et cliquez sur le network par d&eacute;faut.</span></p><p class="c0"><span></span></p><p class="c5"><img height="394" src="images/image00.png" width="705"></p><p class="c0"><span></span></p><p class="c5"><span>Une fois dans l&rsquo;&eacute;cran de configura&lt;tion du Network, cr&eacute;ez une nouvelle r&egrave;gle firewall pour permettre d&rsquo;acc&eacute;der au port 8080 des machines.</span></p><p class="c0"><span></span></p><p class="c5"><img height="384" src="images/image03.png" width="705"></p><p class="c0"><span></span></p><p class="c5"><img height="501" src="images/image21.png" width="557"></p><p class="c5"><span>R&eacute;essayez maintenant d&rsquo;acc&eacute;der en http &agrave; votre instance via le port 8080, et vous devriez avoir l&rsquo;&eacute;cran suivant : </span></p><p class="c0"><span></span></p><p class="c5"><img height="284" src="images/image27.png" width="705"></p><h2 class="c5"><a name="h.6mf3gmo84piw"></a><span>3.3 - D&eacute;ploiement de petclinic</span></h2><p class="c0"><span></span></p><p class="c5"><span class="c4">{{page.projectName}}-tomcat-1</span></p><a href="#" name="fe7c050f6b7c0983de938ed62e990380609ac1a6"></a><a href="#" name="4"></a><table cellpadding="0" cellspacing="0" class="c16"><tbody><tr class="c11"><td class="c12"><p class="c5"><span class="c7 c9">wget -O petclinic.war http://commondatastorage.googleapis.com/petclinic%2Fpetclinic.war &amp;&amp; sudo mv petclinic.war /var/lib/tomcat7/webapps/ &nbsp;</span></p></td></tr></tbody></table><p class="c0"><span></span></p><p class="c5"><img height="408" src="images/image12.png" width="666"></p><h2 class="c5"><a name="h.e1j3jx4fffh1"></a><span>3.4 - Cr&eacute;ation d&rsquo;une base de donn&eacute;es Google Cloud SQL</span></h2><p class="c5"><span>La base de donn&eacute;es Google Cloud SQL est tout simplement une base de donn&eacute;es MySql. </span></p><p class="c5"><span>Pour cr&eacute;er un nouveau serveur Cloud SQL allez dans la section &ldquo;Cloud SQL&rdquo; et cliquez sur &ldquo;NEW INSTANCE&rdquo; </span></p><p class="c5"><img height="367" src="images/image10.png" width="493"></p><p class="c5"><span>Dans le formulaire de cr&eacute;ation de l&rsquo;instance Cloud SQL vous allez remplir le nom de l&rsquo;instance &ldquo;petclinic-db&rdquo;, la r&eacute;gion &ldquo;United States&rdquo; et nous allons demander &agrave; obtenir une adresse IP fixe pour notre instance Cloud SQL : ce sera important pour la configuration jdbc de notre application petclinic afin de lui fournir un moyen de trouver le serveur de base de donn&eacute;es !</span></p><p class="c0"><span></span></p><p class="c5"><img height="400" src="images/image02.png" width="581"></p><p class="c5 c15"><img height="451" src="images/image19.png" width="527"></p><p class="c0"><span></span></p><p class="c5"><span>Apr&egrave;s la confirmation de cr&eacute;ation de notre serveur il d&eacute;marre et s&rsquo;affiche dans la console.</span></p><p class="c5"><span>Il est possible d&rsquo;acc&eacute;der aux informations de l&rsquo;instance Cloud SQL en cliquant sur l&rsquo;</span><span class="c14">instance id</span><span>:</span></p><p class="c5"><img height="267" src="images/image08.png" width="624"></p><p class="c0"><span></span></p><p class="c5"><img height="536" src="images/image15.png" width="624"></p><p class="c5"><span>Dans l&rsquo;onglet &ldquo;Summary&rdquo; on note la pr&eacute;sence de l&rsquo;adresse IP de notre instance Cloud SQL, IP que nous allons utiliser lors de la configuration jdbc de petclinic.</span></p><p class="c0"><span></span></p><p class="c5"><span>&Eacute;galement, puisque nous n&rsquo;avons pas fourni l&rsquo;IP autoris&eacute;e &agrave; acc&eacute;der &agrave; l&rsquo;instance SQL, nous constatons qu&rsquo;il n&rsquo;est pas possible de se connecter &agrave; notre instance (</span><span class="c14">Authorized IP Addresses: None authorized</span><span>). La prochaine &eacute;tape consiste donc &agrave; ajouter cette autorisation.</span></p><p class="c0"><span></span></p><h2 class="c5"><a name="h.i13fkd1hyfvb"></a><span>3.5 - Autoriser Tomcat &agrave; acc&eacute;der &agrave; l&rsquo;instance Cloud SQL</span></h2><p class="c5"><span>Afin d&rsquo;ajouter notre serveur Tomcat &agrave; acc&eacute;der &agrave; notre instance Cloud SQL il nous faut r&eacute;cup&eacute;rer l&rsquo;adresse IP du serveur sur lequel il s&rsquo;ex&eacute;cute:</span></p><p class="c5"><img height="224" src="images/image26.png" width="624"></p><p class="c5"><span>Une fois l&rsquo;external IP address du serveur not&eacute;e, retournez dans la partie Cloud SQL</span></p><p class="c5"><img height="536" src="images/image23.png" width="624"></p><p class="c0"><span></span></p><p class="c5"><span>Puis dans la partie &ldquo;</span><span class="c14">Assign IP Address</span><span>&rdquo; ajouter l&rsquo;adresse IP dans &ldquo;</span><span class="c14">Authorized IP Addresses</span><span>&rdquo;</span></p><p class="c5"><img height="299" src="images/image16.png" width="624"></p><p class="c0"><span></span></p><p class="c5"><span>Et enfin pour terminer avec la config de l&rsquo;instance SQL, il faut affecter un mot de passe au user </span><span class="c14">root</span><span>&nbsp;:</span></p><p class="c5"><img height="333" src="images/image06.png" width="624"></p><p class="c0"><span></span></p><p class="c5"><span>Maintenant nous pouvons fournir &agrave; Tomcat la configuration permettant d&rsquo;acc&eacute;der &agrave; l&rsquo;instance Cloud SQL.</span></p><p class="c0"><span></span></p><p class="c5"><span>Nous allons fournir la configuration dans le fichier </span><span class="c14">catalina.properties</span></p><p class="c0"><span class="c4"></span></p><p class="c5"><span class="c4">{{page.projectName}}-tomcat-1</span></p><a href="#" name="8fff4d046fe9f2e4dc266d97a218d868eacaf2bf"></a><a href="#" name="5"></a><table cellpadding="0" cellspacing="0" class="c16"><tbody><tr class="c11"><td class="c12"><p class="c5"><span class="c7 c9">sudo nano /var/lib/tomcat7/conf/catalina.properties</span></p></td></tr></tbody></table><p class="c0"><span></span></p><p class="c0"><span></span></p><p class="c5"><span>Dans le fichier copiez la configuration suivante a la fin du fichier (Attention de bien utiliser l&rsquo;instance de l&rsquo;adresse IP de votre instance Cloud SQL) :</span></p><p class="c0"><span></span></p><p class="c19 c5"><span class="c4">jpa.database=MYSQL</span></p><p class="c19 c5"><span class="c4">jdbc.initLocation=classpath:db/mysql/initDB.sql</span></p><p class="c5 c19"><span class="c4">jdbc.dataLocation=classpath:db/mysql/populateDB.sql</span></p><p class="c19 c5"><span class="c4">jdbc.driverClassName=com.mysql.jdbc.Driver</span></p><p class="c19 c5"><span class="c4">jdbc.url=jdbc:mysql://</span><span class="c14 c7 c21">METTRE_ICI_LADRESSE_IP_DE_VOTRE_INSTANCE_CLOUD_SQL</span><span class="c4">/</span></p><p class="c19 c5"><span class="c4">jdbc.dbname=petclinic</span></p><p class="c19 c5"><span class="c4">jdbc.username=root</span></p><p class="c19 c5"><span class="c4">jdbc.password=root</span></p><p class="c19 c0"><span class="c7"></span></p><p class="c5"><span>Puis red&eacute;marrez le serveur tomcat :</span></p><p class="c0"><span></span></p><p class="c5"><span class="c4">{{page.projectName}}-tomcat-1</span></p><a href="#" name="c5f01c0cf31d37b333c60320e6d40f8a65d6ba36"></a><a href="#" name="6"></a><table cellpadding="0" cellspacing="0" class="c16"><tbody><tr class="c11"><td class="c12"><p class="c5"><span class="c7 c9">sudo /etc/init.d/tomcat7 restart</span></p></td></tr></tbody></table><p class="c0"><span></span></p><h1 class="c5"><a name="h.zey36j5g0ghl"></a><span>4 - Cr&eacute;ation d&rsquo;une seconde instance &agrave; partir de la premi&egrave;re</span></h1><h2 class="c5"><a name="h.slmc1aqbm210"></a><span>4.1 - Cr&eacute;ation d&rsquo;un snapshot</span></h2><p class="c0"><span></span></p><p class="c5"><span>Pour cr&eacute;er un snapshot, allez dans la section snapshots et cliquez sur New Snapshot</span></p><p class="c0"><span></span></p><p class="c5"><img height="371" src="images/image05.png" width="705"></p><p class="c5"><span>Dans l&rsquo;&eacute;cran de cr&eacute;ation du snapshot : </span></p><p class="c5"><span>&nbsp;- Name : {{page.projectName}}-snapshot</span></p><p class="c5"><span>&nbsp;- Source Disk : {{page.projectName}}-tomcat-1</span></p><p class="c5"><img height="286" src="images/image04.png" width="566"></p><h2 class="c5"><a name="h.htvcqsgil4pb"></a><span>4.2 - Cr&eacute;ation de la seconde instance en ligne de commande</span></h2><p class="c0"><span></span></p><p class="c5"><span>Pour cr&eacute;er la seconde instance en ligne de commande, il faut le faire en deux temps : </span></p><p class="c5"><span>&nbsp;- Cr&eacute;er un nouveau disque &agrave; partir du snapshot (choisir europe-west pour la zone)</span></p><p class="c5"><span>&nbsp;- Cr&eacute;er une instance attach&eacute;e &agrave; ce nouveau disque </span></p><p class="c0"><span></span></p><p class="c5"><span class="c4">Local</span></p><a href="#" name="9c14d1b71733c8649202625765f18c5d99a95d7e"></a><a href="#" name="7"></a><table cellpadding="0" cellspacing="0" class="c16"><tbody><tr class="c11"><td class="c12"><p class="c5"><span class="c7 c9">gcutil adddisk --source_snapshot={{page.projectName}}-snapshot {{page.projectName}}-tomcat-2-disk</span></p><p class="c0"><span class="c7 c9"></span></p><p class="c5"><span class="c17 c7 c9">1: europe-west1-a &nbsp;(maintenance starts in 53 days)</span></p><p class="c5"><span class="c17 c7 c9">2: europe-west1-b &nbsp;(maintenance starts in 109 days)</span></p><p class="c5"><span class="c17 c7 c9">3: us-central1-a</span></p><p class="c5"><span class="c17 c7 c9">4: us-central1-b</span></p><p class="c5"><span class="c17 c7 c9">5: us-central2-a &nbsp;(maintenance starts in 35 days) (DEPRECATED)</span></p><p class="c5"><span class="c7 c9">&gt;&gt;&gt;</span><span class="c4 c9">&nbsp;2</span></p><p class="c0"><span class="c7 c9"></span></p><p class="c0"><span class="c7 c9"></span></p><p class="c5"><span class="c7 c9">gcutil addinstance {{page.projectName}}-tomcat-2 --disk {{page.projectName}}-tomcat-2-disk</span><span class="c7 c9">,mode=rw,boot</span></p><p class="c0"><span class="c7 c9"></span></p><p class="c5"><span class="c17 c7 c9">[...]</span></p><p class="c5"><span class="c17 c7 c9">19: n1-highmem-8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8 vCPUs, 52 GB RAM</span></p><p class="c5"><span class="c7 c9 c17">20: n1-highmem-8-d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;8 vCPUs, 52 GB RAM, 2 scratch disks (1770 GB, 1770 GB)</span></p><p class="c5"><span class="c17 c7 c9">21: f1-micro&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 vCPU (shared physical core) and 0.6 GB RAM</span></p><p class="c5"><span class="c17 c7 c9">22: g1-small&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 vCPU (shared physical core) and 1.7 GB RAM</span></p><p class="c5"><span class="c7 c9">&gt;&gt;&gt; </span><span class="c4 c9">21</span></p><p class="c0"><span class="c7 c9"></span></p></td></tr></tbody></table><p class="c0"><span></span></p><h2 class="c5"><a name="h.a6dlfclqm65p"></a><span>4.3 V&eacute;rifier que l&rsquo;on acc&egrave;de bien au petclinic sur la seconde instance</span></h2><p class="c0"><span></span></p><p class="c5"><span>Rep&eacute;rez dans l&rsquo;output de la commande pr&eacute;c&eacute;dent l&rsquo;ip publique de l&rsquo;instance et connectez-vous sur le port 8080 en http. Apr&egrave;s acc&eacute;dez &agrave; petclinic.</span></p><p class="c0"><span></span></p><h1 class="c5"><a name="h.eslvtsrragcc"></a><span>5 - Cr&eacute;ation d&rsquo;un load balancing</span></h1><p class="c0"><span></span></p><p class="c5"><span>La cr&eacute;ation d&rsquo;un load balancing n&eacute;cessite plusieurs &eacute;l&eacute;ments : </span></p><p class="c5"><span>&nbsp;- Une target pool, qui va contenir les instances o&ugrave; distribuer les requ&ecirc;tes</span></p><p class="c5"><span>&nbsp;- Des forwarding rules, pour d&eacute;crire quoi rediriger vers quelle target pool</span></p><p class="c5"><span>&nbsp;- Des health checks, pour tester la sant&eacute; des noeuds</span></p><p class="c0"><span></span></p><h2 class="c5"><a name="h.ldtzssrw2oxl"></a><span>5.1 Cr&eacute;ation d&rsquo;une target pool</span></h2><p class="c0"><span></span></p><p class="c5"><img height="411" src="images/image24.png" width="705"></p><p class="c0"><span></span></p><p class="c5"><span>Dans l&rsquo;&eacute;cran de cr&eacute;ation de la target pool : </span></p><p class="c5"><span>&nbsp;- Name : {{page.projectName}}-pool</span></p><p class="c5"><span>&nbsp;- Region : europe-west1</span></p><p class="c5"><span>&nbsp;- VM Instances : {{page.projectName}}-tomcat-1 &amp; {{page.projectName}}-tomcat-2</span></p><p class="c5"><span>&nbsp;- Session Affinity : Client IP</span></p><p class="c0"><span></span></p><p class="c5"><img height="484" src="images/image07.png" width="585"></p><h2 class="c5"><a name="h.deb1y6eksnuv"></a><span>5.2 - Cr&eacute;ation d&rsquo;un Forwarding Rule</span></h2><p class="c0"><span></span></p><p class="c5"><img height="437" src="images/image17.png" width="705"></p><p class="c5"><span>Dans l&rsquo;&eacute;cran de cr&eacute;ation de la forwarding rule : </span></p><p class="c5"><span>&nbsp;- Name : {{page.projectName}}-forwarding-rule</span></p><p class="c5"><span>&nbsp;- Region : europe-west1</span></p><p class="c5"><span>&nbsp;- Protocol : TCP</span></p><p class="c5"><span>&nbsp;- Target pool : {{page.projectName}}-pool</span></p><p class="c0"><span></span></p><p class="c5"><img height="464" src="images/image09.png" width="592"></p><h2 class="c5"><a name="h.7903yvvqrmvw"></a><span>5.3 - Cr&eacute;ation d&rsquo;un Health Check</span></h2><p class="c0"><span></span></p><p class="c5"><img height="403" src="images/image11.png" width="705"></p><p class="c5"><span>Dans l&rsquo;&eacute;cran de cr&eacute;ation du health check: </span></p><p class="c5"><span>&nbsp;- Name : {{page.projectName}}-health-check</span></p><p class="c5"><span>&nbsp;- Port : 8080</span></p><p class="c5"><span>&nbsp;- Path : /petclinic/</span></p><p class="c0"><span></span></p><p class="c5"><img height="502" src="images/image25.png" width="568"></p><p class="c0"><span></span></p><p class="c5"><span>Une fois le health chek cr&eacute;&eacute;, retournez dans l&rsquo;onglet Target Pools et associez-le &agrave; votre pool. Au bout de quelques secondes, rafra&icirc;chissez la page de la pool et les indicateurs passeront au vert. </span></p><p class="c5"><img height="381" src="images/image13.png" width="426"></p><h2 class="c5"><a name="h.2s9zpc9t683x"></a><span>5.4 - Se connecter &agrave; l&rsquo;ip du load balancer</span></h2><p class="c5"><span>&nbsp;- Allez dans l&rsquo;onglet de la forwarding rule et rep&eacute;rer l&rsquo;ip externe</span></p><p class="c5"><span>&nbsp;- Se connecter dessus sur le port 8080</span></p><p class="c0"><span></span></p><h2 class="c5"><a name="h.8320u58bvy5j"></a><span>5.5 - Couper une VM</span></h2><p class="c0"><span></span></p><p class="c5"><span>&nbsp;- Allez dans la partie VM Instances et couper une VM</span></p><p class="c5"><span>&nbsp;- Rafraichir la page petclinic et voir que l&rsquo;on tombe bien sur l&rsquo;autre VM</span></p><p class="c5"><span>&nbsp;- Allez voir dans le target pool que le health check de la VM est down</span></p></body></html>
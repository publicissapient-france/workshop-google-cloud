---
layout: main
cssDir: ../stylesheets
javascriptsDir: ../javascripts
---
<p class="c0"><span class="c6">Votre project Compute Engine a pour project ID {{page.projectId}}</span></p><p class="c3 c0"><span></span></p><p class="c10 c0"><span class="c2"><a class="c5" href="#h.rhj5fkexxyn6">1 - Cr&eacute;er une instance compute engine via la console web</a></span></p><p class="c10 c0"><span class="c2"><a class="c5" href="#h.1j10rvh061q0">2 - Connexion en ssh &agrave; l&rsquo;instance</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.stcm0kfqk1y7">2.1 - Installer le gcutil tool</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.5q3dg5lj6u94">2.2 - S&rsquo;authentifier avec votre projet {{page.projectId}}</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.s39hhemk030t">2.3 - Mettre en cache le nom du projet</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.b04dqrcycs4q">2.4 - Connexion en ssh &agrave; l&rsquo;instance</a></span></p><p class="c0 c10"><span class="c2"><a class="c5" href="#h.h2c2qp88j5e7">3 - Installation de petclinc</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.brcr4cc2d4y6">3.1 - Installation de tomcat 7</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.af8fc3ctmpg5">3.2 - Acc&eacute;der &agrave; la page de test de tomcat 7</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.6mf3gmo84piw">3.3 - Deploiement de petclinic</a></span></p><p class="c10 c0"><span class="c2"><a class="c5" href="#h.zey36j5g0ghl">4 - Cr&eacute;ation d&rsquo;une seconde instance &agrave; partir de la premi&egrave;re</a></span></p><p class="c0 c4"><span class="c2"><a class="c5" href="#h.slmc1aqbm210">4.1 - Cr&eacute;ation d&rsquo;un snapshot</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.htvcqsgil4pb">4.2 - Cr&eacute;ation de la seconde instance en ligne de commande</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.a6dlfclqm65p">4.3 V&eacute;rifier que l&rsquo;on acc&egrave;de bien au petclinic sur la seconde instance</a></span></p><p class="c10 c0"><span class="c2"><a class="c5" href="#h.eslvtsrragcc">5 - Cr&eacute;ation d&rsquo;un load balancing</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.ldtzssrw2oxl">5.1 Cr&eacute;ation d&rsquo;une target pool</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.deb1y6eksnuv">5.2 - Cr&eacute;ation d&rsquo;un Forwarding Rule</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.7903yvvqrmvw">5.3 - Cr&eacute;ation d&rsquo;un Health Check</a></span></p><p class="c4 c0"><span class="c2"><a class="c5" href="#h.2s9zpc9t683x">5.4 - Se connecter &agrave; l&rsquo;ip du load balancer</a></span></p><p class="c10 c0"><span class="c2"><a class="c5" href="#h.5xvaq7flt21g">6 - Sujets Bonux</a></span></p><h1 class="c0"><a name="h.rhj5fkexxyn6"></a><span>1 - Cr&eacute;er une instance compute engine via la console web</span></h1><p class="c3 c0"><span></span></p><p class="c0"><span>&nbsp;- Allez sur la console web de votre projet : </span><span class="c2"><a class="c5" href="https://cloud.google.com/console#/project/apps~%7B%7Bpage.projectId%7D%7D">https://cloud.google.com/console#/project/apps~{{page.projectId}}</a></span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="358" src="images/image04.png" width="628"></p><p class="c0"><span>&nbsp;- Cliquez sur VM Instances et cliquez sur le bouton New Instance</span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="370" src="images/image12.png" width="705"></p><p class="c0"><span>&nbsp;- Sur l&rsquo;&eacute;cran de creation de la nouvelle instance : </span></p><ul class="c7 lst-kix_y60use42zoqv-0 start"><li class="c1 c0"><span>Name : {{page.projectName}}-tomcat-1</span></li><li class="c0 c1"><span>Zone : europe-west1-a</span></li><li class="c1 c0"><span>Machine Type : f1-micro</span></li></ul><p class="c3 c0"><span></span></p><p class="c0"><img height="400" src="images/image18.png" width="705"></p><p class="c0"><span>&nbsp;- Une fois cr&eacute;&eacute;e, l&rsquo;instance d&eacute;marre en quelques secondes</span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="383" src="images/image16.png" width="705"></p><p class="c3 c0"><span></span></p><h1 class="c0"><a name="h.1j10rvh061q0"></a><span>2 - Connexion en ssh &agrave; l&rsquo;instance</span></h1><h2 class="c0"><a name="h.stcm0kfqk1y7"></a><span>2.1 - Installer le gcutil tool</span></h2><p class="c3 c0"><span></span></p><p class="c0"><span>&nbsp;- Pour le t&eacute;l&eacute;charger : </span><span class="c2"><a class="c5" href="https://google-compute-engine-tools.googlecode.com/files/gcutil-1.8.4.tar.gz">https://google-compute-engine-tools.googlecode.com/files/gcutil-1.8.4.tar.gz</a></span></p><p class="c0"><span>&nbsp;- D&eacute;zipper dans le r&eacute;pertoire de votre choix.</span></p><p class="c0"><span>&nbsp;- Ajouter dans votre PATH l&rsquo;acc&egrave;s aux binaires:</span></p><p class="c3 c0"><span class="c8"></span></p><p class="c0"><span class="c8">export PATH=$PATH:&lt;YOUR PATH TO GCUTIL&gt;</span></p><p class="c3 c0"><span></span></p><h2 class="c0"><a name="h.5q3dg5lj6u94"></a><span>2.2 - S&rsquo;authentifier avec votre projet </span><span>{{page.projectId}}</span></h2><p class="c3 c0"><span></span></p><p class="c0"><span>&nbsp;- La premi&egrave;re chose avant commencer est de vous authentifier :</span></p><p class="c3 c0"><span class="c8"></span></p><p class="c0"><span class="c8">gcutil auth</span></p><p class="c3 c0"><span class="c8"></span></p><h2 class="c0"><a name="h.s39hhemk030t"></a><span>2.3 - Mettre en cache le nom du projet</span></h2><p class="c3 c0"><span></span></p><p class="c0"><span>&nbsp;- Pour &eacute;viter d&rsquo;avoir &agrave; retaper le nom du projet &agrave; chaque commande, vous pouvez mettre en cache le flag du nom du projet : </span></p><p class="c3 c0"><span></span></p><p class="c0"><span class="c8">gcutil --project={{page.projectId}} getproject --cache_flag_values</span></p><p class="c3 c0"><span class="c8"></span></p><h2 class="c0"><a name="h.b04dqrcycs4q"></a><span>2.4 - Connexion en ssh &agrave; l&rsquo;instance </span></h2><p class="c3 c0"><span></span></p><p class="c0"><span class="c8">gcutil ssh {{page.projectName}}-tomcat-1</span></p><p class="c3 c0"><span></span></p><p class="c0"><span>Notez au passage que lors de l&rsquo;ex&eacute;cution de commande, gcutil vous donne la commande ssh utilis&eacute;e pour se connecter &agrave; votre instance. Par exemple:</span></p><p class="c0"><span class="c8 c12">INFO: Running command line: ssh -o UserKnownHostsFile=/dev/null -o CheckHostIP=no -o StrictHostKeyChecking=no -i /Users/jbclaramonte/.ssh/google_compute_engine -A -p 22 jbclaramonte@192.157.29.85 --</span></p><h1 class="c0"><a name="h.h2c2qp88j5e7"></a><span>3 - Installation de petclinc</span></h1><h2 class="c0"><a name="h.brcr4cc2d4y6"></a><span>3.1 - Installation de tomcat 7</span></h2><p class="c3 c0"><span></span></p><p class="c0"><span class="c8">sudo apt-get install tomcat7</span></p><p class="c3 c0"><span></span></p><h2 class="c0"><a name="h.af8fc3ctmpg5"></a><span>3.2 - Acc&eacute;der &agrave; la page de test de tomcat 7</span></h2><p class="c3 c0"><span></span></p><p class="c0"><span>Pour acc&eacute;der &agrave; votre instance en http, utiliser l&rsquo;ip qui est afficher sur la page de liste des instances de votre projet : </span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="383" src="images/image06.png" width="705"></p><p class="c3 c0"><span></span></p><p class="c0"><span>Et par d&eacute;faut, tomcat expose sur le port 8080. </span></p><p class="c0 c3"><span></span></p><p class="c0"><span>On s&rsquo;aper&ccedil;oit que l&rsquo;on ne peut pas acc&eacute;der au port 8080 par d&eacute;faut. Il faut configurer les r&egrave;gles firewall.</span></p><p class="c3 c0"><span></span></p><p class="c0"><span>Pour se faire : </span></p><p class="c3 c0"><span></span></p><p class="c0"><span>- Allez dans la section Network de Compute Engine</span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="394" src="images/image13.png" width="705"></p><p class="c3 c0"><span></span></p><p class="c0"><span>Une fois dans l&rsquo;&eacute;cran de configuration du Network, cr&eacute;ez une nouvelle r&egrave;gle firewall pour permettre d&rsquo;acc&eacute;der au port 8080 des machines.</span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="384" src="images/image05.png" width="705"></p><p class="c3 c0"><span></span></p><p class="c0"><img height="501" src="images/image03.png" width="557"></p><p class="c0"><span>Reessayez maintenant d&rsquo;acc&eacute;der en http &agrave; votre instance via le port 8080, et vous devriez avoir l&rsquo;&eacute;cran suivant : </span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="284" src="images/image02.png" width="705"></p><h2 class="c0"><a name="h.6mf3gmo84piw"></a><span>3.3 - Deploiement de petclinic</span></h2><p class="c3 c0"><span></span></p><p class="c0"><span>sudo gsutil cp gs://petclinic/petclinic.war /var/lib/tomcat7/webapps/</span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="408" src="images/image15.png" width="666"></p><h1 class="c0"><a name="h.zey36j5g0ghl"></a><span>4 - Cr&eacute;ation d&rsquo;une seconde instance &agrave; partir de la premi&egrave;re</span></h1><h2 class="c0"><a name="h.slmc1aqbm210"></a><span>4.1 - Cr&eacute;ation d&rsquo;un snapshot</span></h2><p class="c3 c0"><span></span></p><p class="c0"><span>Pour cr&eacute;er un snapshot, allez dans la section snapshots et cliquez sur New Snapshot</span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="371" src="images/image10.png" width="705"></p><p class="c0"><span>Dans l&rsquo;&eacute;cran de cr&eacute;ation du snapshot : </span></p><p class="c0"><span>&nbsp;- Name : {{page.projectName}}-snapshot</span></p><p class="c0"><span>&nbsp;- Source Disk : {{page.projectName}}-tomcat-1</span></p><p class="c0"><img height="286" src="images/image09.png" width="566"></p><h2 class="c0"><a name="h.htvcqsgil4pb"></a><span>4.2 - Cr&eacute;ation de la seconde instance en ligne de commande</span></h2><p class="c3 c0"><span></span></p><p class="c0"><span>Pour cr&eacute;er la seconde instance en ligne de commande il faut faire &ccedil;a en 2 temps : </span></p><p class="c0"><span>&nbsp;- Cr&eacute;er un nouveau disque &agrave; partir du snapshot (choisir europe-west pour la zone)</span></p><p class="c0"><span>&nbsp;- Cr&eacute;er une instance attach&eacute;e &agrave; ce nouveau disque </span></p><p class="c3 c0"><span></span></p><p class="c0"><span>gcutil adddisk --source_snapshot={{page.projectName}}-snapshot {{page.projectName}}-tomcat-2-disk</span></p><p class="c3 c0"><span></span></p><p class="c0"><span>gcutil addinstance {{page.projectName}}-tomcat-2 --disk {{page.projectName}}-tomcat-2-disk</span><sup><a href="#cmnt1" name="cmnt_ref1">[a]</a></sup><span>,mode=rw,boot</span></p><h2 class="c0"><a name="h.a6dlfclqm65p"></a><span>4.3 V&eacute;rifier que l&rsquo;on acc&egrave;de bien au petclinic sur la seconde instance</span></h2><p class="c3 c0"><span></span></p><p class="c0"><span>R&eacute;p&eacute;rer dans l&rsquo;output de la commande pr&eacute;c&eacute;dent l&rsquo;ip publique de l&rsquo;instance et connectez-vous sur le port 8080 en http. Apr&egrave;s acc&eacute;dez &agrave; petclinic.</span></p><p class="c3 c0"><span></span></p><h1 class="c0"><a name="h.eslvtsrragcc"></a><span>5 - Cr&eacute;ation d&rsquo;un load balancing</span></h1><p class="c3 c0"><span></span></p><p class="c0"><span>La cr&eacute;ation d&rsquo;un load balancing n&eacute;cessite plusieurs &eacute;l&eacute;ments : </span></p><p class="c0"><span>&nbsp;- Une target pool, qui va contenir les instances o&ugrave; distribuer les requ&ecirc;tes</span></p><p class="c0"><span>&nbsp;- Des forwarding rules, pour d&eacute;crire quoi rediriger vers quelle target pool</span></p><p class="c0"><span>&nbsp;- Des health checks, pour tester la santer des noeuds</span></p><p class="c3 c0"><span></span></p><h2 class="c0"><a name="h.ldtzssrw2oxl"></a><span>5.1 Cr&eacute;ation d&rsquo;une target pool</span></h2><p class="c3 c0"><span></span></p><p class="c0"><img height="411" src="images/image17.png" width="705"></p><p class="c3 c0"><span></span></p><p class="c0"><span>Dans l&rsquo;&eacute;cran de cr&eacute;ation de la target pool : </span></p><p class="c0"><span>&nbsp;- Name : {{page.projectName}}-pool</span></p><p class="c0"><span>&nbsp;- Region : europe-west1</span></p><p class="c0"><span>&nbsp;- VM Instances : {{page.projectName}}-tomcat-1 &amp; {{page.projectName}}-tomcat-2</span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="484" src="images/image00.png" width="585"></p><h2 class="c0"><a name="h.deb1y6eksnuv"></a><span>5.2 - Cr&eacute;ation d&rsquo;un Forwarding Rule</span></h2><p class="c3 c0"><span></span></p><p class="c0"><img height="437" src="images/image08.png" width="705"></p><p class="c0"><span>Dans l&rsquo;&eacute;cran de cr&eacute;ation de la forwarding rule : </span></p><p class="c0"><span>&nbsp;- Name : {{page.projectName}}-forwarding-rule</span></p><p class="c0"><span>&nbsp;- Region : europe-west1</span></p><p class="c0"><span>&nbsp;- Protocol : TCP</span></p><p class="c0"><span>&nbsp;- Target pool : {{page.projectName}}-pool</span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="464" src="images/image01.png" width="592"></p><h2 class="c0"><a name="h.7903yvvqrmvw"></a><span>5.3 - Cr&eacute;ation d&rsquo;un Health Check</span></h2><p class="c3 c0"><span></span></p><p class="c0"><img height="403" src="images/image11.png" width="705"></p><p class="c0"><span>Dans l&rsquo;&eacute;cran de cr&eacute;ation de la forwarding rule : </span></p><p class="c0"><span>&nbsp;- Name : {{page.projectName}}-health-check</span></p><p class="c0"><span>&nbsp;- Port : 8080</span></p><p class="c0"><span>&nbsp;- Path : /petclinic/</span></p><p class="c3 c0"><span></span></p><p class="c0"><img height="502" src="images/image07.png" width="568"></p><p class="c3 c0"><span></span></p><p class="c0"><span>Une fois cr&eacute;&eacute;, associ&eacute; le health check &agrave; votre pool. Au bout de quelques secondes, rafra&icirc;chissez la page de la pool et les indicateurs passeront au vert. </span></p><p class="c0"><img height="381" src="images/image14.png" width="426"></p><h2 class="c0"><a name="h.2s9zpc9t683x"></a><span>5.4 - Se connecter &agrave; l&rsquo;ip du load balancer</span></h2><p class="c0"><span>&nbsp;- Allez dans l&rsquo;onglet de la forwarding rule et rep&eacute;rer l&rsquo;ip externe</span></p><p class="c0"><span>&nbsp;- Se connecter dessus sur le port 8080</span></p><p class="c3 c0"><span></span></p><p class="c0"><span>On peut voir ici qu&rsquo;il n&rsquo;y a pas de session stickyness car on tombe sur l&rsquo;une ou l&rsquo;autre instance.</span></p><h1 class="c0"><a name="h.5xvaq7flt21g"></a><span>6 - Sujets Bonux</span></h1><p class="c3 c0"><span></span></p><p class="c0"><span>- Cr&eacute;ation d&rsquo;une instance en java avec l&rsquo;api : </span><span class="c2"><a class="c5" href="https://code.google.com/p/google-api-java-client/wiki/APIs#Compute_Engine_API">https://code.google.com/p/google-api-java-client/wiki/APIs#Compute_Engine_API</a></span></p><p class="c0"><span>&nbsp;</span></p><p class="c0"><span>- Raccordement de Google Cloud SQL a une instance Compute Engine</span></p><p class="c0"><span>(Il semblerait que ce ne soit pas super sec encore&hellip; On y acc&egrave;de pas forc&eacute;ment simplement d&rsquo;une machine externe mais par contre d&rsquo;une application sur une vm&hellip; hum&hellip;)</span></p><p class="c3 c0"><span></span></p><div class="c13"><p class="c11 c0"><a href="#cmnt_ref1" name="cmnt1">[a]</a><span>Jean-Baptiste Claramonte:</span></p><p class="c0 c11"><span>indiquer quelle zone choisir ?</span></p></div>
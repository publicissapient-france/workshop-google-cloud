---
layout: main
cssDir: ../stylesheets
javascriptsDir: ../javascripts
---
<html><head><title>Atelier Google Cloud - 19 avril - french tech</title><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">.lst-kix_y60use42zoqv-2>li:before{content:"\0025a0  "}ul.lst-kix_y60use42zoqv-3{list-style-type:none}ul.lst-kix_y60use42zoqv-4{list-style-type:none}ul.lst-kix_y60use42zoqv-1{list-style-type:none}ul.lst-kix_y60use42zoqv-2{list-style-type:none}ul.lst-kix_y60use42zoqv-0{list-style-type:none}.lst-kix_y60use42zoqv-5>li:before{content:"\0025a0  "}.lst-kix_y60use42zoqv-4>li:before{content:"\0025cb  "}.lst-kix_y60use42zoqv-1>li:before{content:"\0025cb  "}.lst-kix_y60use42zoqv-8>li:before{content:"\0025a0  "}.lst-kix_y60use42zoqv-0>li:before{content:"\0025cf  "}ul.lst-kix_y60use42zoqv-8{list-style-type:none}ul.lst-kix_y60use42zoqv-7{list-style-type:none}.lst-kix_y60use42zoqv-3>li:before{content:"\0025cf  "}ul.lst-kix_y60use42zoqv-6{list-style-type:none}.lst-kix_y60use42zoqv-7>li:before{content:"\0025cb  "}ul.lst-kix_y60use42zoqv-5{list-style-type:none}.lst-kix_y60use42zoqv-6>li:before{content:"\0025cf  "}ol{margin:0;padding:0}.c1{border-bottom-width:1pt;border-top-style:solid;width:468pt;background-color:#434343;border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-bottom-style:solid;vertical-align:top;border-top-color:#000000;border-left-color:#000000;border-right-color:#000000;border-left-style:solid;border-right-width:1pt;border-left-width:1pt}.c7{vertical-align:baseline;color:#00ff00;font-size:11pt;font-style:normal;text-decoration:none;font-weight:normal}.c8{line-height:1.0;padding-top:0pt;text-align:left;padding-bottom:0pt}.c10{line-height:1.15;padding-top:0pt;text-align:left;padding-bottom:0pt}.c6{margin-right:auto;border-collapse:collapse}.c12{max-width:468pt;background-color:#ffffff;padding:72pt 72pt 72pt 72pt}.c3{color:#1155cc;text-decoration:underline}.c18{font-size:8pt;font-style:italic}.c21{font-size:10pt;font-style:italic}.c22{margin:0;padding:0}.c5{color:inherit;text-decoration:inherit}.c9{widows:2;orphans:2}.c11{font-weight:bold}.c24{color:#00ff00}.c16{page-break-after:avoid}.c4{font-family:"Courier New"}.c23{font-style:italic}.c14{margin-left:36pt}.c15{height:0pt}.c0{direction:ltr}.c17{padding-left:0pt}.c19{text-align:right}.c20{padding-top:10pt}.c2{height:11pt}.c13{margin-left:18pt}.title{widows:2;padding-top:0pt;line-height:1.15;orphans:2;text-align:left;color:#000000;font-size:21pt;font-family:"Trebuchet MS";padding-bottom:0pt;page-break-after:avoid}.subtitle{widows:2;padding-top:0pt;line-height:1.15;orphans:2;text-align:left;color:#666666;font-style:italic;font-size:13pt;font-family:"Trebuchet MS";padding-bottom:10pt;page-break-after:avoid}li{color:#000000;font-size:11pt;font-family:"Arial"}p{color:#000000;font-size:11pt;margin:0;font-family:"Arial"}h1{widows:2;padding-top:10pt;line-height:1.15;orphans:2;text-align:left;color:#000000;font-size:16pt;font-family:"Trebuchet MS";padding-bottom:0pt;page-break-after:avoid}h2{widows:2;padding-top:10pt;line-height:1.15;orphans:2;text-align:left;color:#000000;font-size:13pt;font-family:"Trebuchet MS";font-weight:bold;padding-bottom:0pt;page-break-after:avoid}h3{widows:2;padding-top:8pt;line-height:1.15;orphans:2;text-align:left;color:#666666;font-size:12pt;font-family:"Trebuchet MS";font-weight:bold;padding-bottom:0pt;page-break-after:avoid}h4{widows:2;padding-top:8pt;line-height:1.15;orphans:2;text-align:left;color:#666666;font-size:11pt;text-decoration:underline;font-family:"Trebuchet MS";padding-bottom:0pt;page-break-after:avoid}h5{widows:2;padding-top:8pt;line-height:1.15;orphans:2;text-align:left;color:#666666;font-size:11pt;font-family:"Trebuchet MS";padding-bottom:0pt;page-break-after:avoid}h6{widows:2;padding-top:8pt;line-height:1.15;orphans:2;text-align:left;color:#666666;font-style:italic;font-size:11pt;font-family:"Trebuchet MS";padding-bottom:0pt;page-break-after:avoid}</style></head><body class="c12"><p class="c0 c2"><span></span></p><p class="c9 c0 c13"><span class="c3"><a class="c5" href="#h.3jzvxtxx8fhl">1 - Create a new compute engine instance using the web console</a></span></p><p class="c9 c0 c13"><span class="c3"><a class="c5" href="#h.1j10rvh061q0">2 - SSH connection to the VM instance</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.stcm0kfqk1y7">2.1 - Connect on the proxy bouncing (from which you&rsquo;ll have access to the Google Compute Engine project)</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.xdho0ie3ugwc">2.4 - Connect to your instance with ssh</a></span></p><p class="c9 c0 c13"><span class="c3"><a class="c5" href="#h.h2c2qp88j5e7">3 - Petclinic sample WebApp installation</a></span></p><p class="c9 c0 c14"><span class="c3"><a class="c5" href="#h.brcr4cc2d4y6">3.1 - Tomcat7 installation</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.af8fc3ctmpg5">3.2 - Access to the tomcat7 test page</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.6mf3gmo84piw">3.3 - Deploying petclinic WebApp</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.e1j3jx4fffh1">3.4 - Create a Google Cloud SQL instance</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.i13fkd1hyfvb">3.5 - Authorize Tomcat to access Cloud SQL instance</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.t1v4clxjok4t">3.6 - Access the petclinic application</a></span></p><p class="c9 c0 c13"><span class="c3"><a class="c5" href="#h.zey36j5g0ghl">4 - Create another instance using the first one as a template</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.slmc1aqbm210">4.1 - Create a snapshot of the first instance</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.htvcqsgil4pb">4.2 - Create the new instance using the command line</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.a6dlfclqm65p">4.3 Check that we can access the petclinic application on the new instance</a></span></p><p class="c9 c0 c13"><span class="c3"><a class="c5" href="#h.eslvtsrragcc">5 - Create a load balancing</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.ldtzssrw2oxl">5.1 Create a Target Pool</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.deb1y6eksnuv">5.2 - Create a new Forwarding rule</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.7903yvvqrmvw">5.3 - Create a Health Check</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.2s9zpc9t683x">5.4 - Use the load balancing</a></span></p><p class="c9 c14 c0"><span class="c3"><a class="c5" href="#h.8320u58bvy5j">5.5 - Stop a Tomcat server</a></span></p><h1 class="c0"><a name="h.3jzvxtxx8fhl"></a><span>1 - Create a new compute engine instance using the web console</span></h1><p class="c9 c0 c2"><span></span></p><p class="c9 c0"><span>&nbsp;- In Chrome, open a new incognito window to ensure you won&rsquo;t use your personal account.</span></p><p class="c0"><span>&nbsp;- In the incognito window go to the Google Cloud web console using this url: </span><span class="c3"><a class="c5" href="https://console.developers.google.com/project/apps~xebia-demo">https://console.developers.google.com/project/apps~xebia-demo</a></span></p><p class="c0"><span>&nbsp;- Use the login password </span><span>we just gave you.</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 628.00px; height: 358.00px;"><img alt="" src="images/image15.png" style="" title=""></span></p><p class="c0"><span>&nbsp;- Click on &rdquo;VM Instances&rdquo; then click then&ldquo;New Instance&rdquo; button</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 705.00px; height: 370.69px;"><img alt="" src="images/image20.png" style="" title=""></span></p><p class="c0"><span>&nbsp;- On the new instance creation screen provide the following informations : </span></p><ul class="c22 lst-kix_y60use42zoqv-0 start"><li class="c14 c0 c17"><span>Name : {{page.projectName}}-tomcat-1</span></li><li class="c14 c0 c17"><span>Zone : {{page.projectZone}}</span></li><li class="c14 c0 c17"><span>Machine Type : f1-micro</span></li><li class="c14 c0 c17"><span>Image : debian-7</span></li></ul><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 705.00px; height: 400.48px;"><img alt="" src="images/image00.png" style="" title=""></span></p><p class="c0"><span>&nbsp;- Once you&rsquo;ve clicked on &ldquo;Create&rdquo;, the instance should be up and running in a few seconds</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 705.00px; height: 383.83px;"><img alt="" src="images/image17.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><h1 class="c0 c20"><a name="h.1j10rvh061q0"></a><span>2 - SSH connection to the VM instance</span></h1><h2 class="c0 c20"><a name="h.stcm0kfqk1y7"></a><span>2.1 - Connect on the proxy bouncing (from which you&rsquo;ll have access to the Google Compute Engine project)</span></h2><p class="c0 c2"><span></span></p><p class="c0 c2"><span></span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 608.00px; height: 329.00px;"><img alt="" src="images/image18.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><p class="c0 c2"><span></span></p><p class="c0"><span class="c11 c4">Local</span></p><a href="#" name="26c3bdbf32b16e2314777bf49d55445bdf315992"></a><a href="#" name="0"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c0 c8"><span class="c7 c4">ssh -i google_compute_engine eric@146.148.14.19</span></p></td></tr></tbody></table><p class="c0 c2"><span class="c4"></span></p><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.xdho0ie3ugwc"></a><span>2.4 - Connect to your instance with ssh</span></h2><p class="c9 c0 c2"><span></span></p><p class="c0"><span class="c11 c4">Proxy Bouncing</span></p><a href="#" name="661ee566c8ba4fca24098389a53627b8a20665e6"></a><a href="#" name="1"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c10 c0"><span class="c7 c4">gcutil ssh {{page.projectName}}-tomcat-1</span></p></td></tr></tbody></table><p class="c0 c2"><span class="c4 c18"></span></p><h1 class="c0"><a name="h.h2c2qp88j5e7"></a><span>3 - Petclinic sample WebApp installation</span></h1><h2 class="c0"><a name="h.brcr4cc2d4y6"></a><span>3.1 - Tomcat7 installation</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span class="c11 c4">{{page.projectName}}-tomcat-1</span></p><a href="#" name="f35cec1591b02998087a6a560906352c50e28eff"></a><a href="#" name="2"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c10 c0"><span class="c7 c4">sudo apt-get -y install tomcat7</span></p></td></tr></tbody></table><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.af8fc3ctmpg5"></a><span>3.2 - Access to the tomcat7 test page</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>To access your instance using http you need to know its external IP. Using the web console you can get it from the instances list screen:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 705.00px; height: 383.83px;"><img alt="" src="images/image11.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>Now try to access your instance using your browser, with an url looking something like this :</span></p><p class="c0"><span class="c3"><a class="c5" href="http://www.google.com/url?q=http%3A%2F%2Fcopy.here.you.instance.ip%3A8080%2F&amp;sa=D&amp;sntz=1&amp;usg=AFQjCNFu9C6e9nZy9Z56i8eVD32TKQ-yBA">http://use.here.your.instance.external.ip:8080/</a></span><span>&nbsp;and you should see the following page:</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 705.00px; height: 284.85px;"><img alt="" src="images/image25.png" style="" title=""></span></p><h2 class="c0"><a name="h.6mf3gmo84piw"></a><span>3.3 - Deploying petclinic WebApp</span></h2><p class="c0"><span>While on the {{page.projectName}}-tomcat-1}} instance copy and past the following command line. It will download the petclinic.war file (war file is used for java webapp packaging) and copy the file in tomcat7 directory:</span></p><p class="c0"><span class="c11 c4">{{page.projectName}}-tomcat-1</span></p><a href="#" name="f1138817fc397667ecfce045ad63e80c3f1895f1"></a><a href="#" name="3"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c10 c0"><span class="c7 c4">gsutil cp gs://petclinic-demo/petclinic.war . &amp;&amp; sudo mv petclinic.war /var/lib/tomcat7/webapps/ &nbsp;</span></p></td></tr></tbody></table><p class="c0 c2"><span></span></p><p class="c0"><span>Once installed this won&rsquo;t work yet, we need to have a mysql database to connect to, so let&rsquo;s continue ...</span></p><h2 class="c16 c0"><a name="h.e1j3jx4fffh1"></a><span>3.4 - Create a Google Cloud SQL instance</span></h2><p class="c0"><span>A Cloud SQL instance is simply a MySql database in the cloud.</span></p><p class="c0"><span>To create a new Cloud SQL click on &ldquo;Cloud SQL&rdquo; and click on &ldquo;NEW INSTANCE&rdquo; :</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 493.00px; height: 367.82px;"><img alt="" src="images/image08.png" style="" title=""></span></p><p class="c0"><span>In the Cloud SQL creation form fill the instance name with &ldquo;</span><span>{{page.projectName}}</span><span class="c11 c4">-</span><span>petclinic-db&rdquo;, for the region select &ldquo;{{page.projectZone}}&rdquo;.</span></p><p class="c0"><span>Also in the same form select &ldquo;Assign IP Address&rdquo; : this is important because we&rsquo;ll need this IP to configure the petclinic application.</span></p><p class="c0 c19"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 436.06px; height: 454.75px;"><img alt="" src="images/image01.png" style="" title=""></span></p><p class="c0 c19"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 527.00px; height: 451.41px;"><img alt="" src="images/image16.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>Once you confirm the Cloud SQL instance creation it will start in a few seconds. You can then access the Cloud SQL informations by clicking on the instance id :</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 294.06px;"><img alt="" src="images/image06.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>Then in the &ldquo;Overview&rdquo; tab notice the IP address of your Cloud SQL instance. Copy the IP and paste it somewhere, we are going to use it in the next step.</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 631.53px;"><img alt="" src="images/image12.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><h2 class="c0 c16"><a name="h.i13fkd1hyfvb"></a><span>3.5 - Authorize Tomcat to access Cloud SQL instance</span></h2><p class="c0"><span>We need to configure the Cloud SQL to add our instance running Tomcat server in the Authorized IP.</span></p><p class="c0"><span>In &ldquo;Compute Engine&rdquo; -&gt; &ldquo;VM Instances&rdquo; copy the &ldquo;External Address&rdquo; of your Tomcat instance :</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 224.64px;"><img alt="" src="images/image24.png" style="" title=""></span></p><p class="c0"><span>To paste the IP Click on &ldquo;Cloud SQL&rdquo; -&gt; &ldquo;Edit&rdquo;:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 347.10px;"><img alt="" src="images/image21.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>Then in &ldquo;</span><span class="c23">Authorized IP Addresses</span><span>&rdquo; text field paste the Tomcat external IP:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 299.49px;"><img alt="" src="images/image13.png" style="" title=""></span></p><p class="c0"><span>Finally, in the &ldquo;Access Control&rdquo; tab, set a password to the Cloud SQL root user (as in the example use &ldquo;root&rdquo; for the password):</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 333.56px;"><img alt="" src="images/image04.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>Now we can finalize the Tomcat configuration by setting the information to access the Cloud SQL.</span></p><p class="c0"><span>We need to edit the catalina.properties file:</span></p><p class="c0 c2"><span class="c11 c4"></span></p><p class="c0"><span class="c11 c4">Command to be run on {{page.projectName}}-tomcat-1</span></p><a href="#" name="8fff4d046fe9f2e4dc266d97a218d868eacaf2bf"></a><a href="#" name="4"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c10 c0"><span class="c4 c7">sudo nano /var/lib/tomcat7/conf/catalina.properties</span></p></td></tr></tbody></table><p class="c0 c2"><span></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>At the end of the file copy the following properties (WARNING: don&rsquo;t forget to replace </span><span class="c21 c4">SET_HERE_THE_IP_OF_YOUR_CLOUD_SQL_INSTANCE</span><span>&nbsp;with the correct IP:</span></p><p class="c0 c2"><span></span></p><p class="c10 c0"><span class="c11 c4">jpa.database=MYSQL</span></p><p class="c0 c10"><span class="c11 c4">jdbc.initLocation=classpath:db/mysql/initDB.sql</span></p><p class="c10 c0"><span class="c11 c4">jdbc.dataLocation=classpath:db/mysql/populateDB.sql</span></p><p class="c10 c0"><span class="c11 c4">jdbc.driverClassName=com.mysql.jdbc.Driver</span></p><p class="c10 c0"><span class="c11 c4">jdbc.url=jdbc:mysql://</span><span class="c4 c21">SET_HERE_THE_IP_OF_YOUR_CLOUD_SQL_INSTANCE</span></p><p class="c10 c0"><span class="c11 c4">jdbc.dbname=petclinic</span></p><p class="c10 c0"><span class="c11 c4">jdbc.username=root</span></p><p class="c10 c0"><span class="c4 c11">jdbc.password=root</span></p><p class="c10 c0 c2"><span class="c4"></span></p><p class="c0"><span>Restart tomcat server to reload the configuration</span></p><p class="c0 c2"><span></span></p><p class="c0"><span class="c11 c4">Command to be run on {{page.projectName}}-tomcat-1</span></p><a href="#" name="c5f01c0cf31d37b333c60320e6d40f8a65d6ba36"></a><a href="#" name="5"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c10 c0"><span class="c7 c4">sudo /etc/init.d/tomcat7 restart</span></p></td></tr></tbody></table><p class="c0 c2"><span></span></p><h2 class="c16 c0"><a name="h.t1v4clxjok4t"></a><span>3.6 - Access the petclinic application</span></h2><p class="c9 c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 666.00px; height: 408.00px;"><img alt="" src="images/image19.png" style="" title=""></span></p><p class="c9 c0"><span>To access the petclinic application get the external IP of your instance and put the url in your browser :</span></p><p class="c9 c0"><span>http://put.the.external.ip.here:8080/petclinic</span></p><p class="c0 c2"><span></span></p><h1 class="c0"><a name="h.zey36j5g0ghl"></a><span>4 - Create another instance using the first one as a template</span></h1><h2 class="c0"><a name="h.slmc1aqbm210"></a><span>4.1 - Create a snapshot of the first instance</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>To create a snapshot click on &ldquo;Snapshots&rdquo; and the on &ldquo;NEW SNAPSHOT&rdquo;:</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 705.00px; height: 371.78px;"><img alt="" src="images/image03.png" style="" title=""></span></p><p class="c0"><span>In the page &ldquo;Create a new snapshot&rdquo; fill as follow:</span></p><p class="c0"><span>&nbsp;- Name : {{page.projectName}}-snapshot</span></p><p class="c0"><span>&nbsp;- Source Disk : {{page.projectName}}-tomcat-1</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 566.00px; height: 286.36px;"><img alt="" src="images/image02.png" style="" title=""></span></p><h2 class="c0"><a name="h.htvcqsgil4pb"></a><span>4.2 - Create the new instance using the command line</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>To be able to create our new instance using the command line, we have to do it in two steps:</span></p><p class="c0"><span>&nbsp;- first step : we create a new disk using the snapshot we&rsquo;ve just created (choose {{page.projectZone}} for the zone)</span></p><p class="c0"><span>&nbsp;- second step : create a new instance and attach the disk created in step one to it</span></p><p class="c0 c2"><span></span></p><p class="c0"><span class="c11 c4">Command to be run on Local</span></p><a href="#" name="24d68f06a87184db64877b8f35f50d7b15d57c79"></a><a href="#" name="6"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c10 c0"><span class="c7 c4">gcutil adddisk --source_snapshot={{page.projectName}}-snapshot {{page.projectName}}-tomcat-2-disk</span></p><p class="c10 c0 c2"><span class="c7 c4"></span></p><p class="c10 c0"><span class="c4 c24">gcutil addinstance {{page.projectName}}-tomcat-2 --disk {{page.projectName}}-tomcat-2-disk</span><span class="c7 c4">,mode=rw,boot</span></p></td></tr></tbody></table><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.a6dlfclqm65p"></a><span>4.3 Check that we can access the petclinic application on the new instance</span></h2><p class="c9 c0 c2"><span></span></p><p class="c9 c0"><span>You should check that you can access the petclinic application on the new instance. </span></p><p class="c9 c0"><span>To do that get the external IP of the new instance and connect to it as you&rsquo;ve done in </span><span class="c23">3.6 - Access the petclinic application</span></p><p class="c0 c2"><span></span></p><h1 class="c0"><a name="h.eslvtsrragcc"></a><span>5 - Create a load balancing</span></h1><p class="c0 c2"><span></span></p><p class="c0"><span>Creating a load balancing is done with three building blocks :</span></p><p class="c0"><span>&nbsp;- Target pool to </span><span>define a group of instances that should receive incoming traffic from forwarding rules</span></p><p class="c0"><span>&nbsp;- Forwarding rules </span><span>to direct traffic to specific target pools</span></p><p class="c0"><span>&nbsp;- Health check, </span><span>to determine the health of your instances</span></p><p class="c0 c2"><span></span></p><h2 class="c0"><a name="h.ldtzssrw2oxl"></a><span>5.1 Create a Target Pool</span></h2><p class="c0"><span>Click on &ldquo;Load balancing&rdquo;, select the &ldquo;Target pools&rdquo; tab, and then Click on &ldquo;NEW TARGET POOL&rdquo; :</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 705.00px; height: 411.74px;"><img alt="" src="images/image22.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>In the &ldquo;Create a new target pool&rdquo; page fill with the following informations:</span></p><p class="c0"><span>&nbsp;- Name : {{page.projectName}}-pool</span></p><p class="c0"><span>&nbsp;- Region : {{page.projectZone}}</span></p><p class="c0"><span>&nbsp;- VM Instances : {{page.projectName}}-tomcat-1 &amp; {{page.projectName}}-tomcat-2</span></p><p class="c0"><span>&nbsp;- Session Affinity : Client IP</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 585.00px; height: 484.75px;"><img alt="" src="images/image05.png" style="" title=""></span></p><h2 class="c0"><a name="h.deb1y6eksnuv"></a><span>5.2 - Create a new Forwarding rule</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>Select &ldquo;Forwarding rules&rdquo; tab then click on &ldquo;NEW FORWARDING RULE&rdquo;:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 705.00px; height: 437.52px;"><img alt="" src="images/image14.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>In the &ldquo;Create a new forwarding rule&rdquo; page fill with the following informations :</span></p><p class="c0"><span>&nbsp;- Name : {{page.projectName}}-forwarding-rule</span></p><p class="c0"><span>&nbsp;- Region : {{page.projectZone}}</span></p><p class="c0"><span>&nbsp;- Protocol : TCP</span></p><p class="c0"><span>&nbsp;- Target pool : {{page.projectName}}-pool</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 592.00px; height: 464.18px;"><img alt="" src="images/image07.png" style="" title=""></span></p><h2 class="c0"><a name="h.7903yvvqrmvw"></a><span>5.3 - Create a Health Check</span></h2><p class="c0 c2"><span></span></p><p class="c0"><span>Select &ldquo;Health checks&rdquo; tab then click on &ldquo;NEW HEALTH CHECK&rdquo;:</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 705.00px; height: 403.29px;"><img alt="" src="images/image09.png" style="" title=""></span></p><p class="c0"><span>In the &ldquo;Create a new health check&rdquo; page fill with the following informations :</span></p><p class="c0"><span>&nbsp;- Name : {{page.projectName}}-health-check</span></p><p class="c0"><span>&nbsp;- Port : 8080</span></p><p class="c0"><span>&nbsp;- Path : /petclinic/</span></p><p class="c0 c2"><span></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 568.00px; height: 502.89px;"><img alt="" src="images/image23.png" style="" title=""></span></p><p class="c0 c2"><span></span></p><p class="c0"><span>When the health check is saved, go back to the Target Pools tab, click on the &ldquo;demo-pool&rdquo; you previously created and associate it with your target pool :</span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 426.00px; height: 381.00px;"><img alt="" src="images/image10.png" style="" title=""></span></p><h2 class="c0"><a name="h.2s9zpc9t683x"></a><span>5.4 - Use the load balancing</span></h2><p class="c0"><span>&nbsp;- Select the forwarding rule tab and copy its external IP</span></p><p class="c0"><span>&nbsp;- With your browser use the external IP and the 8080 port to connect to your load balancer:</span></p><p class="c0"><span>http://copy.load.balancer.external.ip.here:8080/petclinic</span></p><p class="c0 c2"><span></span></p><h2 class="c16 c0"><a name="h.8320u58bvy5j"></a><span>5.5 - Stop a Tomcat server</span></h2><p class="c9 c0"><span>We are going to stop one of our Tomcat server to see that the load balancing will stop sending request to it as soon as it has detected the server is down :</span></p><p class="c9 c0 c2"><span></span></p><p class="c9 c0"><span>Connect to one of your instance :</span></p><p class="c0 c2"><span class="c4"></span></p><a href="#" name="661ee566c8ba4fca24098389a53627b8a20665e6"></a><a href="#" name="7"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c10 c0"><span class="c7 c4">gcutil ssh {{page.projectName}}-tomcat-1</span></p></td></tr></tbody></table><p class="c0 c2"><span></span></p><p class="c9 c0"><span>Stop the Tomcat server :</span></p><p class="c0 c2"><span class="c4"></span></p><p class="c0"><span class="c11 c4">Command to be run on {{page.projectName}}-tomcat-1</span></p><a href="#" name="855711ddff1b92f2bdc884c4493de64140b73934"></a><a href="#" name="8"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c10 c0"><span class="c7 c4">sudo /etc/init.d/tomcat7 stop</span></p></td></tr></tbody></table><p class="c0 c2"><span></span></p><p class="c9 c0"><span>Reload the front page a few times &hellip; notice that first http request may still being forwarded to the stopped Tomcat server but just for a few seconds. Eventually only one server will be targeted.</span></p><p class="c9 c0 c2"><span></span></p><p class="c9 c0"><span>Now restart the Tomcat server:</span></p><p class="c9 c0 c2"><span></span></p><p class="c0"><span class="c11 c4">Command to be run on {{page.projectName}}-tomcat-1</span></p><a href="#" name="67cb79d94641e6d17480f598089a7651613b076c"></a><a href="#" name="9"></a><table cellpadding="0" cellspacing="0" class="c6"><tbody><tr class="c15"><td class="c1"><p class="c10 c0"><span class="c7 c4">sudo /etc/init.d/tomcat7 start</span></p></td></tr></tbody></table><p class="c0 c2"><span></span></p><p class="c0 c9"><span>Again Reload the front page a few times &hellip; and notice that the http request will finally be forwarded again to the restarted tomcat server. Alleluia !</span></p><p class="c9 c0 c2"><span></span></p></body></html>